
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
        <script type="text/javascript" src="scripts/jquery-2.0.2.js"></script>
        <script type="text/javascript" src="scripts/helix-mobile-full.js"></script>
		<script type="text/javascript" src="scripts/bootstrap-3.2.0-dist/js/bootstrap.js"></script>
		<link rel="stylesheet" type="text/css" href="styles/helix-mobile-full.css">
		<link rel="stylesheet" type="text/css" href="styles/bootstrap-3.2.0-dist/css/bootstrap.min.css" >
		<link rel="stylesheet" type="text/css" href="styles/chat.css" >
		
    </head>
    <body>
		<div id="chat"><h3>Messages:<br><br>
		
		
		<div id="login-form" class="input-group input-group-lg center-block" >
			<br><input id="username" type="text" class="form-control" placeholder="username"></input>
			<br><input id="password" type="password" class="form-control" placeholder="password"></input>
			<br><span class="input-group-btn form-group">
				<button id="login-btn" class="btn btn-default" type="button" onclick="logmein();">Log in</button>
			</span>
		</div>
		
		<div id="thechat" class="input-group input-group-lg center-block" >
			<pre id="chatwindow" class="pre-scrollable">loading messages...</pre>
			<input type="text" class="form-control" placeholder="your message..." id="messagebox"></input>
			<span class="input-group-btn">
				<button id="send" class="btn btn-default" type="button" onclick='send()'>Send</button>
			</span>
		</div>
		</div>
		
		
		<script type="text/javascript">
		initHelixDB();
		definePersistenceMigrations();
		Helix.DB.initPersistence();
		
		var stateBananager = {
			thread_id: null,
			user: null
		};
		
		$(document).on('hxPersistenceReady', function () {
			$("#thechat").hide();
			$("#login-form").show();
							
			var r = {
					created: '',
					message: '',
					message_id:  '',
					msg_from: '',
					msg_to: ''
			};
			
			var schemaa = Helix.DB.prepareSchemaTemplate(r, "messageTable", "message_id");
			console.log(schemaa);
			
			var thread = {
				//Thread: {
					thread_id: '',
				//},
				Message: schemaa
			};
			
			var schema2 = Helix.DB.prepareSchemaTemplate(thread, "threadTable", "thread_id");
			console.log(schema2);
			
			Helix.DB.generatePersistenceSchema(schema2, "threadSchema", function () {
				persistence.dump(function (dump) {
					console.log(dump);
				});
			});
			/*
			//Nik: what exactly are you synchronizing here??
			Helix.DB.synchronizeObject(thread,Helix.DB.getSchemaForTable("threadTable"),function() {
				console.log(thread);
				},null,null,null
			);
			*/
			
			logmein();
		});
			
		var m

		
		function logmein() {
			$("#login-form").hide();
			$.ajax({
			  //type: "POST",
			  dataType: 'jsonp',
			  url: 'http://link-sdkdemo1.rhcloud.com/users/loggedin',
			  data: {
			  },
			  success: function(data){
				//alert('that worked');
				window.d3 = $.parseJSON(data);
				var d = $.parseJSON(data);
				
				if (d.success === true )
					getThreads();
				else{
					$.ajax({
					  //type: "POST",
					  dataType: 'jsonp',
					  url: 'http://link-sdkdemo1.rhcloud.com/users/login',
					  data: {
						User: {
						  username: $("#username").val(),
						  password: $("#password").val(),				  
						}
					  },
					  success: function(data){
						//alert('that worked');
						window.d3 = $.parseJSON(data);
						var d = $.parseJSON(data);
						if (d.success === true ) {
							getThreads();
							stateBananager.user = d.payload;
						}
						else 
							$("#login-form").show();
					  },
					  error: function(data){
						console.log(data);
						$("#login-form").show();
					  }
					});
				
				}
					
			  },
			  error: function(data){
				console.log(data);
				$("#login-form").show();
			  }
			});


		}
		
		function getThreads() {
			$("#thechat").show();
			$.ajax({
				  //type: "POST",
				  dataType: 'jsonp',
				  url: 'http://link-sdkdemo1.rhcloud.com/threads/index',
				  data: "",
				  success: function(data){
				    
					//alert('that worked');
					window.d3 = $.parseJSON(data);
					var d = $.parseJSON(data);
				  }
				});	  
			
		
		}

		function getMessages() {
			$("#thechat").show();
			$.ajax({
				 //type: "POST",
				 dataType: 'jsonp',
				 url: 'http://link-sdkdemo1.rhcloud.com/threads/view',
				 data: {
					thread_id: 2
				},
				success: function(data){
				    
					//alert('that worked');
					window.d3 = $.parseJSON(data);
					var d = $.parseJSON(data);
				}
				});	  
			
		
		}

		function send() {
			var m = {
				Thread: {
					thread_id: 2
				},
				Message:{
					//created: '',
					message: document.getElementById('messagebox').value,
					//message_id:  4,
					msg_from: stateBananager.user,
					msg_to: ''
				}
			};
			$.ajax({
				 //type: "POST",
				 dataType: 'jsonp',
				 url: 'http://link-sdkdemo1.rhcloud.com/messages/add',
				 data: m,
				success: function(data){
					print();
					//alert('that worked');
					window.d3 = $.parseJSON(data);
					var d = $.parseJSON(data);
				}
			});	  
			

		}


		function print() {
		var record;
			Helix.DB.synchronizeObjectByKey(2/*document.getElementById('IDbox').value*/, Helix.DB.getSchemaForTable("threadTable"), function (obj) {
				record = obj.Message;
				$('#chatwindow').append(JSON.stringify(record) + "<br />");
				var m = {
					thread_id: 2,
					Message: JSON.stringify(record)
				};
				Helix.DB.synchronizeObject(m,
					Helix.DB.getSchemaForTable("threadTable"),
					function () {
						//alert(JSON.stringify(m));
					},
					null, null, null
				);
			});
		}
		
		function delta() {
			Helix.DB.generatePersistenceSchema({
			__hx_schema_name: 'threadTable',
			__hx_key : 'threadCount',
			Message : ''},
			'TestSchemaGen', function() {// Schema is ready. Now add to it.
				m = {
					"adds":[{
					'Message':document.getElementById('deltabox').value
					}],
					"updates":{},
					"deletes":{}
				};
				alert(JSON.stringify(m));
				
				Helix.DB.synchronizeDeltaObject(
					m,
					Helix.DB.getSchemaForTable("threadTable"),
					function () {
						//alert(JSON.stringify(m));
					},
					null, null, null
				);
				print();
			})
		}
        </script>
		
    </body>
</html> 