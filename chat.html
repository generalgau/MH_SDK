<html>
    <head>
        <script type="text/javascript" src="scripts/jquery-2.0.2.js"></script>
        <script type="text/javascript" src="scripts/helix-mobile-full.js"></script>
        <link rel="stylesheet" type="text/css" href="styles/helix-mobile-full.css">
    </head>
    <body>
		<div id="chat">Messages:<br><br></div>
        <script type="text/javascript">
		initHelixDB();
		definePersistenceMigrations();
		Helix.DB.initPersistence();
		
		$(document).on('hxPersistenceReady', function () {
				var s = {
				messageID:'',
				To:'',
				From:'',
				Time:'',
				Message: ''
				};
				
				var schemaa = Helix.DB.prepareSchemaTemplate(s, "messageTable", "messageID");
				console.log(schemaa);
				
				var thread = {
				threadCount:1,
				messages: schemaa
				};
				
				var threadTable = Helix.DB.prepareSchemaTemplate(thread, "threadTable", "threadCount");
				console.log(threadTable);
				Helix.DB.generatePersistenceSchema(threadTable, "threadSchema", function () {
					persistence.dump(function (dump) {
						console.log(dump);
					});
				});
				
				Helix.DB.synchronizeObject(thread,Helix.DB.getSchemaForTable("threadTable"),function() {
					console.log(thread);
					},null,null,null
				);
			});
			
		var m
		function send() {
			m = {
				'messageID':document.getElementById('IDbox').value,
				'To':'',
				'From':'',
				'Time':'',
				'Message':document.getElementById('composebox').value
			};
			Helix.DB.synchronizeObject(m,
			Helix.DB.getSchemaForTable("messageTable"),
			function () {
				//alert(JSON.stringify(m));
			},
			null, null, null);
			print();
		}
		function print() {
		var record;
			Helix.DB.synchronizeObjectByKey(document.getElementById('IDbox').value, Helix.DB.getSchemaForTable("messageTable"), function (obj) {
				record = obj["_data"];
				$('#chat').append(JSON.stringify(record) + "<br />");
			});
		}
		function delta() {
			Helix.DB.generatePersistenceSchema({
			__hx_schema_name: 'threadTable',
			__hx_key : 'threadCount',
			Message : ''},
			'TestSchemaGen', function() {// Schema is ready. Now add to it.
				m = {
					"adds":[{
					'Message':document.getElementById('deltabox').value
					}],
					"updates":{},
					"deletes":{}
				};
				alert(JSON.stringify(m));
				
				Helix.DB.synchronizeDeltaObject(
					m,
					Helix.DB.getSchemaForTable("threadTable"),
					function () {
						//alert(JSON.stringify(m));
					},
					null, null, null
				);
				print();
			})
		}
        </script>
		<form name="banana" action="" method="get">
			<input type="button" name="sendd" value="SEND" onclick="send()"/>
			<input type="button" name="deltaa" value="DELTA" onclick="delta();"/>
			<input type='button' name='printt' value='PRINT' onclick='print()'/><br>
			<input type="text" name="composee" id="composebox" value="Send a message...">
			<input type="text" name="deltaaa" id="deltabox" value="New message"/>
			<input type="text" name="messageIDD" id="IDbox" value="1">
		</form>
    </body>
</html> 